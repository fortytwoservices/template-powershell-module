name: Publish Module

on:
  push:
    tags:
      - v*.*.*

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Publish Module to PowerShell Gallery
        shell: pwsh
        run: |
          $psd1 = Get-ChildItem -Recurse -Include *.psd1
          $RequiredModules = [ScriptBlock]::Create((Get-Content -Raw $psd1.FullName)).Invoke().RequiredModules
          if($RequiredModules) {
            $RequiredModules | ForEach-Object {
              Write-Host "Installing required module - $($_)"
              Install-Module -Name $_ -Force -Confirm:$false
            }
          }

          $psd1 |
          ForEach-Object {
            Test-ModuleManifest $_.FullName

            $ModulePath = Split-Path -Parent $_.FullName
            $ModuleName = $_.BaseName
            Write-Host "Publishing module $ModuleName"
            Publish-Module -Path $ModulePath -NuGetApiKey '${{ secrets.POWERSHELLGALLERY_API_KEY }}' -Verbose
          }